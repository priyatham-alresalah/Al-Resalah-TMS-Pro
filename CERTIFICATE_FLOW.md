# Certificate Generation – Full Flow

## 1. Issuance (when certificates are “issued”)

- **Entry:** `pages/issue_certificates.php` → user selects candidates and submits.
- **API:** `api/certificates/issue_bulk.php`
  - Validates training, workflow, and selected candidates.
  - For each selected candidate (without an existing certificate):
    - Gets next certificate number via `includes/certificate_number.php`.
    - **Inserts a row into `certificates`** (Supabase) with: `training_id`, `candidate_id`, `certificate_no`, `issued_date`, `issued_by`, `status`.  
    - **Does not generate or save a PDF at this step.**  
    - Optionally creates/updates `certificate_ready` checkpoint.

So at issuance, only DB rows are created; no PDF file is created yet.

---

## 2. When a PDF is generated

- **Triggers:** Download or Print from Certificates list:
  - **Download:** `api/certificates/download.php?id=<certificate_uuid>`
  - **Print:** `api/certificates/print_pdf.php?id=<certificate_uuid>`

Both scripts follow the same logic:

1. **Load certificate by ID** from Supabase (`certificates` table).
2. **If `file_path` is set and file exists on disk:**  
   - Serve that file (no generation).
3. **Otherwise (on-demand generation):**
   - Load candidate (name, email) from `candidates`.
   - Load training (course_name, training_date, client_id) from `trainings`.
   - Load client (company_name) from `clients`.
   - Call **`generateCertificatePDF(...)`** in `includes/certificate_pdf.php`.
   - **Where it is saved:**
     - **Path:** `uploads/certificates/certificate_<certificate_no>.pdf`  
       e.g. `certificate_ARC-2026-0001.pdf`
     - **Full path:** `project_root/uploads/certificates/`  
       (built in PHP as `__DIR__ . '/../uploads/certificates/'` from `includes/`, or `__DIR__ . '/../../uploads/certificates/'` from `api/certificates/`).
   - **Ensure directory exists:**  
     - `includes/certificate_pdf.php` creates `uploads/certificates/` if missing.  
     - `download.php` and `print_pdf.php` also ensure this directory exists before calling the generator.
   - **Update DB:** PATCH `certificates` row to set `file_path` = `uploads/certificates/certificate_<certificate_no>.pdf`.
   - **Serve:** Send the generated file to the browser (attachment for download, inline for print).

So: **PDF is generated on first download/print**, then **saved under `uploads/certificates/`** and the path is stored in the DB for future requests.

---

## 3. Summary

| Step              | What happens |
|-------------------|--------------|
| Issue certificates| Only DB rows in `certificates`; no PDF yet. |
| First Download/Print | PDF generated by `includes/certificate_pdf.php`, saved to `uploads/certificates/certificate_<no>.pdf`, `file_path` updated in DB, then file served. |
| Later Download/Print | File served from `uploads/certificates/` using `file_path` from DB; no regeneration. |

**Save location:** `training-management-system/uploads/certificates/`  
**File name pattern:** `certificate_<certificate_no>.pdf` (e.g. `certificate_ARC-2026-0001.pdf`)
